# src/vulnerability.py

from __future__ import annotations

import pandas as pd
import numpy as np

from src.load_assets import get_project_root

# Columns in hazards.csv we’ll use for exposure
HAZARD_COLUMNS = [
    "heat_index",
    "freeze_thaw",
    "heavy_rain",
    "flood_risk",
    "wind_extreme",
]


def load_hazards(scenario: str = "2020") -> pd.DataFrame:
    """
    Load climate hazard indicators for a given scenario (e.g., 2020, 2030, 2050).

    Expects data/hazards.csv with columns:
      - asset_id
      - scenario
      - heat_index, freeze_thaw, heavy_rain, flood_risk, wind_extreme  (0–1 indices)
    """
    root = get_project_root()
    path = root / "data" / "hazards.csv"

    df = pd.read_csv(path)

    if "scenario" in df.columns:
        df = df[df["scenario"] == scenario].copy()

    return df


def compute_sensitivity(df: pd.DataFrame) -> pd.Series:
    """
    Compute a simple sensitivity score based on asset age and capacity.

    Idea:
      - Older assets are more sensitive.
      - Higher capacity_kVA transformers/substations may be more sensitive.
    """
    age = df["age_years"].astype(float)
    capacity = df["capacity_kVA"].astype(float)

    age_norm = (age - age.min()) / (age.max() - age.min() + 1e-9)
    cap_norm = (capacity - capacity.min()) / (capacity.max() - capacity.min() + 1e-9)

    sensitivity = 0.6 * age_norm + 0.4 * cap_norm
    return sensitivity.clip(0, 1)


def compute_vulnerability(
    assets_df: pd.DataFrame,
    scenario: str = "2020",
) -> pd.DataFrame:
    """
    Given an asset DataFrame with:
      - asset_id
      - latitude, longitude
      - age_years
      - capacity_kVA
      - criticality (1–5, where 5 = most critical)

    And a hazards.csv that provides per-asset hazard indices for a scenario,
    compute:
      - exposure (0–1, from hazards)
      - sensitivity (0–1, from age & capacity)
      - criticality_norm (0–1)
      - vulnerability_score (0–100)
    """
    df = assets_df.copy()

    # ---- Join hazards ------------------------------------------------------
    hazards = load_hazards(scenario=scenario)

    df = df.merge(hazards, on="asset_id", how="left", suffixes=("", "_haz"))

    # Ensure hazard columns exist and are numeric
    hazard_cols_present = [c for c in HAZARD_COLUMNS if c in df.columns]

    if hazard_cols_present:
        # Fill missing hazard values with 0 (or you could use column means if you prefer)
        df[hazard_cols_present] = df[hazard_cols_present].fillna(0.0)

        # Normalize each hazard across the current portfolio (0–1)
        for col in hazard_cols_present:
            series = df[col].astype(float)
            df[col] = (series - series.min()) / (series.max() - series.min() + 1e-9)

        # Simple equal-weighted exposure index
        exposure = df[hazard_cols_present].mean(axis=1)
    else:
        # Fallback if no hazards are present: medium exposure
        exposure = np.full(len(df), 0.5)

    df["exposure"] = exposure.clip(0, 1)

    # ---- Sensitivity & criticality -----------------------------------------
    df["sensitivity"] = compute_sensitivity(df)

    crit = df["criticality"].astype(float)
    crit_norm = (crit - crit.min()) / (crit.max() - crit.min() + 1e-9)
    df["criticality_norm"] = crit_norm.clip(0, 1)

    # ---- Vulnerability index -----------------------------------------------
    vuln_index = (
        0.4 * df["exposure"]
        + 0.3 * df["sensitivity"]
        + 0.3 * df["criticality_norm"]
    )

    df["vulnerability_score"] = (vuln_index * 100).round(1)

    return df